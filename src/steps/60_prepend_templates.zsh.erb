# Prepend templates
<%= render_templates("src/templates/zshrc") %>
for ZTEMPLATE in ${(k)ZTEMPLATES}; do
  USER_FILE=${${:-<%= home %>/.${ZTEMPLATE}}:A}
  if [[ -e ${USER_FILE} ]]; then
    OLD_USER_FILE=${USER_FILE}.pre-zim
    while [[ -e ${OLD_USER_FILE} ]]; do
      print -u2 "${ZWARN}Existing backup found in ${ZBOLD}${(Dq+)OLD_USER_FILE}${ZNORMAL}"
      OLD_USER_FILE=${USER_FILE}.pre-zim-${(%):-%D{%Y%m%dT%H%M%S.%.}}
    done
    if ERR=$(command mv -f ${USER_FILE} ${OLD_USER_FILE} 2>&1); then
      print -R "${ZOKAY}Backed up existing file to ${ZBOLD}${(Dq+)OLD_USER_FILE}${ZNORMAL}"
    else
      print -u2 -lR "${ZERROR}Error backing up existing file to ${ZBOLD}${(Dq+)OLD_USER_FILE}${ZNORMAL}" ${ERR}
      return 1
    fi
    if ERR=$(print -R ${ZTEMPLATES[${ZTEMPLATE}]} | cat - ${OLD_USER_FILE} > ${USER_FILE} 2>&1); then
      print -R "${ZOKAY}Prepended Zim Framework template to ${ZBOLD}${(Dq+)USER_FILE}${ZNORMAL}"
    else
      print -u2 -lR "${ZERROR}Error prepending Zim Framework template to ${ZBOLD}${(Dq+)USER_FILE}${ZNORMAL}" ${ERR}
      return 1
    fi
  else
    if ERR=$(print -Rn ${ZTEMPLATES[${ZTEMPLATE}]} > ${USER_FILE} 2>&1); then
      print -R "${ZOKAY}Copied Zim Framework template to ${ZBOLD}${(Dq+)USER_FILE}${ZNORMAL}"
    else
      print -u2 -lR "${ZERROR}Error copying Zim Framework template to ${ZBOLD}${(Dq+)USER_FILE}${ZNORMAL}" ${ERR}
      return 1
    fi
  fi
done
